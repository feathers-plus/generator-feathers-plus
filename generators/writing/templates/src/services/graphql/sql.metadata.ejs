
/* eslint-disable no-unused-vars */
// Metadata for forming raw SQL statements for GraphQL. (Can be re-generated.)
<%- insertFragment('imports') %>
<%- insertFragment('init') %>

let moduleExports = function sqlMetadata(app, options) {
  let { convertArgsToFeathers, convertArgsToOrderBy, convertArgsToWhere } = options;
  let makeOrderBy = convertArgsToOrderBy(options);
  let makeWhere = convertArgsToWhere(options);
  <%- insertFragment('func_init') %>

  let returns = {
<%# -%>
<%# --- forEach-1 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(mapping.graphqlSql).forEach(graphqlName => {
  __serviceName = mapping.graphqlSql[graphqlName].service;
  __graphql = feathersSpecs[__serviceName]._extensions.graphql;
  __add = __graphql.add;
-%>

    <%- graphqlName %>: {
      sqlTable: '<%- __graphql.sql.sqlTable %>',
      uniqueKey: '<%- __graphql.sql.uniqueKey %>',
      fields: {
<%# -%>
<%# --- forEach-2 starts below. Loop thru the fields to be renamed. -%>
<% Object.keys(__graphql.sql.sqlColumn).forEach(fieldName => { -%>
        <%- fieldName %>: {
          sqlColumn: '<%- __graphql.sql.sqlColumn[fieldName] %>',
          <%- insertFragment(`fields-${graphqlName}-${fieldName}`) %>
        },
<% }); -%>
<%# --- forEach-2 ends above. -%>
<%# -%>
<%# --- forEach-3 starts below. Loop thru the added fields. -%>
<% Object.keys(__add).forEach(fieldName => {
  __addField = __add[fieldName];
-%>

        // <%- fieldName %><%- __addField.args %>: <%- __addField.type %>
        <%- fieldName %>: {
<%# -%>
<%# --- if/else-1 starts below. -%>
<% if (__addField.serviceName) {
    __temp = [
        '          sqlJoin(ourTable, otherTable) { return `${ourTable}.'
            + __addField.relation.ourTableSql
            + ' = ${otherTable}.'
            + __addField.relation.otherTableSql
            + '`; },',
        '          orderBy(args, content) { return makeOrderBy(args, null); },',
        `          where(table, args) { return makeWhere(table, args, '${__addField.relation.ourTableSql}', undefined); },`,
    ];
-%>
          <%- insertFragment(`fields-${graphqlName}-${fieldName}`, __temp) %>
<% } else { -%>
          <%- insertFragment(`fields-${graphqlName}-${fieldName}-non`, [
            '          sqlExpr: (tableName, args) => { throw Error(\'GraphQL fieldName ${graphqlName}.${fieldName} is not calculated.\'); },',
]) %>
<%# --- if/else-1 ends above. -%>
<% } -%>
<%# --- forEach-3 ends above. -%>
        },
<% }); -%>
<%# --- forEach-1 ends above. -%>
        <%- insertFragment(`fields-${graphqlName}`) %>
      },
      <%- insertFragment(`type-${graphqlName}`) %>
    },
<% }); -%>

    Query: {
      fields: {
<%# -%>
<%# --- forEach-4 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(mapping.graphqlSql).forEach(graphqlName => {
  __serviceName = mapping.graphqlSql[graphqlName].service;
  __graphql = feathersSpecs[__serviceName]._extensions.graphql;
  __uniqueKey = __graphql.sql.uniqueKey;
  __temp = [
    `        // get${graphqlName}(query: JSON, params: JSON, key: JSON): ${graphqlName}`,
    `        get${graphqlName}: {`,
    `          orderBy: (args, content) => makeOrderBy(args, { ${__uniqueKey} : 1 }),`,
    `          where: (table, args) => makeWhere(table, args, '${__uniqueKey}'),`,
    '        },',
    '',
    `        // find${graphqlName}(query: JSON, params: JSON): [${graphqlName}!]`,
    `        find${graphqlName}: {`,
    `          orderBy: (args, content) => makeOrderBy(args, { ${__uniqueKey} : 1 }),`,
    `          where: (table, args) => makeWhere(table, args, '${__uniqueKey}'),`,
    '        },',
  ];
-%>

        <%- insertFragment(`query-${graphqlName}`, __temp) %>
<% }); -%>
<%# --- forEach-4 ends above. -%>
        <%- insertFragment('metadata_query_fields') %>
      },
      <%- insertFragment('metadata_query_more') %>
    },
  <%- insertFragment('metadata_more') %>
  };

  //!code: func_return //!end
  return returns;
};

<%- insertFragment('more') %>

<%- insertFragment('exports') %>
module.exports = moduleExports;

<%- insertFragment('funcs') %>
<%- insertFragment('end') %>
